# 营收数据分析报告

## 问题描述
图片中显示的营收数据与我们当前统计的数据存在较大差异，需要找出cyrg2025数据库中哪个字段组合最接近实际营收。

## 测试数据对比

### 沈阳一二O中学店 (shopId=30)

**目标金额**: ¥455,018.03  
**订单数（图片）**: 36,766  
**订单数（payState=2）**: 36,891

#### 各种统计方式结果:

| 统计方式 | 金额 | 与目标差异 | 差异率 |
|---------|------|-----------|--------|
| 简单使用orderValue (payState=2) | ¥181,833.60 | -¥273,184.43 | -60.0% |
| 简单使用total (payState=2) | ¥161,075.16 | -¥293,942.87 | -64.6% |
| cash+vipAmount (payState=2) | ¥316,666.88 | -¥138,351.15 | -30.4% |
| cash+vipAmount+vipAmountZengSong (payState=2) | ¥318,683.57 | -¥136,334.46 | -30.0% |
| cash+vipAmount+cardAmount+cardZengSong (payState=2) | ¥345,311.88 | -¥109,706.15 | -24.1% |
| 按支付方式分类统计 (payState=2) | ¥374,346.67 | -¥80,671.36 | -17.7% |
| 按支付方式分类统计 (所有订单) | ¥375,484.47 | -¥79,533.56 | -17.5% |

**最接近的统计方式**: 按支付方式分类统计（所有订单），差异17.5%

#### 按支付方式分类的统计逻辑:
```sql
CASE 
    WHEN payMode = '收银机' THEN cash + vipAmount + vipAmountZengSong + cardAmount + cardZengSong
    WHEN payMode LIKE '%外卖%' THEN cash
    WHEN payMode LIKE '%团购%' OR payMode = '小程序' THEN orderValue
    ELSE 0
END
```

### 沈阳一二六中学店 (shopId=1)

**目标金额**: ¥268,854.82  
**订单数（图片）**: 20,984  
**订单数（payState=2）**: 21,016

#### 各种统计方式结果:

| 统计方式 | 金额 | 与目标差异 | 差异率 |
|---------|------|-----------|--------|
| orderValue (payState=2) | ¥88,422.70 | -¥180,432.12 | -67.1% |
| cash+vipAmount (payState=2) | ¥189,959.15 | -¥78,895.67 | -29.3% |
| 按支付方式分类统计 (payState=2) | ¥231,408.77 | -¥37,446.05 | -13.9% |

**最接近的统计方式**: 按支付方式分类统计（payState=2），差异13.9%

## 关键发现

1. **支付方式多样**: 订单表中包含多种支付方式
   - 收银机
   - 美团外卖
   - 饿了么外卖
   - 小程序
   - 美团团购
   - 美团拼好饭

2. **不同支付方式使用不同字段**:
   - 收银机订单: 主要使用 cash + vipAmount + 各种增值字段
   - 外卖订单: 主要使用 cash 字段
   - 小程序/团购: 主要使用 orderValue 字段

3. **数据差异原因分析**:
   - 即使使用最复杂的按支付方式分类统计，仍有13.9%-17.7%的差异
   - 可能的原因:
     a. 时间范围不一致（图片数据可能是特定时间段）
     b. 包含其他收入来源（如配送费、包装费等）
     c. 统计口径差异（可能包含部分未支付或特殊状态订单）
     d. 数据版本差异（备份时间点不同）

## 建议的统计方式

基于测试结果，建议使用**按支付方式分类统计**作为营收统计的标准方式：

```sql
SUM(CASE 
    WHEN payMode = '收银机' THEN cash + vipAmount + ISNULL(vipAmountZengSong, 0) + ISNULL(cardAmount, 0) + ISNULL(cardZengSong, 0)
    WHEN payMode LIKE '%外卖%' THEN cash
    WHEN payMode LIKE '%团购%' OR payMode = '小程序' THEN orderValue
    ELSE 0
END)
FROM Orders 
WHERE shopId = ? AND (delflag = 0 OR delflag IS NULL) AND payState = 2
```

这种方式:
- ✅ 考虑了不同支付方式的特点
- ✅ 包含了会员充值、卡券等增值金额
- ✅ 差异率相对最小（13.9%-17.7%）
- ✅ 符合实际业务逻辑

## 后续行动

1. 与业务方确认:
   - 图片数据的统计时间范围
   - 是否包含其他收入项（配送费、包装费等）
   - 具体的统计口径和业务规则

2. 更新数据迁移逻辑:
   - 采用按支付方式分类统计的方式
   - 重新计算订单金额字段

3. 验证其他门店:
   - 测试更多门店的数据
   - 确认统计方式的普适性

