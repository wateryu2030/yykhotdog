# 高德地图IP访问配置说明

## 问题现象

在外部机器通过IP地址访问时，地图无法显示，即使有铺位信息也无法在地图上显示。

## 问题原因

高德地图API Key可能有**域名/IP白名单限制**。如果API Key设置了白名单，只有白名单中的域名或IP才能正常使用地图服务。

## 解决方案

### 1. 检查高德地图控制台配置

1. **登录高德开放平台**
   - 访问：https://lbs.amap.com/
   - 使用账号登录

2. **进入应用管理**
   - 点击"应用管理" → "我的应用"
   - 找到对应的应用（或创建新应用）

3. **配置API Key白名单**
   - 点击应用名称进入详情
   - 找到"Web端(JS API)"的Key
   - 点击"设置"或"编辑"
   - 在"安全密钥"或"白名单"设置中：
     - **选项1（推荐）：** 添加服务器的IP地址到白名单
       - 例如：`192.168.1.81`
     - **选项2（开发环境）：** 添加IP段
       - 例如：`192.168.1.*` 或 `192.168.*.*`
     - **选项3（生产环境）：** 添加具体域名
       - 例如：`your-domain.com`、`*.your-domain.com`
     - **选项4（临时测试）：** 临时允许所有IP（不推荐用于生产环境）
       - 设置为：`*` 或 留空（根据高德地图控制台的具体选项）

### 2. 当前使用的API Key

当前配置的API Key：`703f67ca1815ae0324022fcf7bc2afe9`

### 3. 需要添加的白名单

根据当前网络环境，需要在白名单中添加：

#### 开发环境（本机IP）
- `192.168.1.81`（主网络接口）
- `localhost` 或 `127.0.0.1`（本地开发）

#### 生产环境
- 服务器的公网IP地址
- 或者访问的域名（如果有域名）

### 4. 配置步骤详解

1. **登录高德开放平台**
   ```
   https://lbs.amap.com/
   ```

2. **进入控制台**
   - 点击右上角头像 → "控制台"
   - 或直接访问：https://console.amap.com/

3. **应用管理**
   - 左侧菜单：应用管理 → 我的应用
   - 找到对应应用，点击"详情"或"编辑"

4. **配置Web端Key的白名单**
   - 找到 "Web端(JS API)" 对应的Key
   - 点击"设置"按钮
   - 在"安全密钥"或"IP白名单"中输入：
     ```
     192.168.1.81
     localhost
     127.0.0.1
     ```
   - 多个IP用换行或逗号分隔（根据控制台提示）
   - 点击"保存"

5. **等待生效**
   - 配置保存后，通常立即生效
   - 如果不行，等待几分钟或清除浏览器缓存

### 5. 验证配置

1. **查看浏览器控制台**
   - 打开开发者工具（F12）
   - 查看Console标签页
   - 查找以下日志：
     - `✅ 高德地图脚本加载成功`
     - `✅ 高德地图API对象已就绪`
     - `✅ 基础地图初始化完成`
     - `📍 准备添加铺位标记`

2. **查看Network标签页**
   - 找到 `webapi.amap.com` 的请求
   - 检查请求状态码：
     - `200`: 正常
     - `403`: API Key无效或IP不在白名单
     - `404`: 请求路径错误

3. **常见错误信息**
   - `INVALID_USER_KEY`: API Key无效
   - `INVALID_USER_DOMAIN`: 域名/IP不在白名单
   - `DAILY_QUERY_OVER_LIMIT`: 每日配额超限

### 6. 调试步骤

如果地图仍然无法显示，按以下步骤检查：

#### 步骤1：检查地图脚本是否加载

在浏览器控制台运行：
```javascript
console.log('AMap对象:', window.AMap);
```

如果输出 `undefined`，说明脚本未加载。

#### 步骤2：检查API Key是否有效

在浏览器控制台查看网络请求：
- 查找 `webapi.amap.com/maps` 请求
- 查看响应内容，如果有错误会显示错误信息

#### 步骤3：检查地图容器

确保地图容器有正确的尺寸：
```javascript
const mapContainer = document.querySelector('[ref*="mapRef"]');
console.log('地图容器尺寸:', mapContainer?.offsetWidth, 'x', mapContainer?.offsetHeight);
```

#### 步骤4：检查坐标数据

检查铺位数据是否有有效的坐标：
```javascript
console.log('铺位数据:', shops);
shops.forEach(shop => {
  console.log(shop.name, '坐标:', shop.longitude, shop.latitude);
});
```

### 7. 临时解决方案（仅用于测试）

如果急需测试，可以临时在高德地图控制台：
1. 将API Key的安全设置改为"允许所有IP"（如果有此选项）
2. **注意：** 这只是临时方案，生产环境必须配置正确的白名单

### 8. 生产环境建议

1. **使用域名访问**
   - 配置域名解析
   - 在高德地图控制台添加域名到白名单
   - 这样比IP地址更稳定

2. **使用HTTPS**
   - 高德地图某些功能需要HTTPS
   - 使用Let's Encrypt等免费SSL证书

3. **限制白名单范围**
   - 不要使用 `*` 允许所有IP
   - 只添加需要的具体IP或域名

## 快速检查清单

- [ ] 高德地图控制台已登录
- [ ] 找到对应的API Key：`703f67ca1815ae0324022fcf7bc2afe9`
- [ ] 已添加服务器IP到白名单（例如：`192.168.1.81`）
- [ ] 已添加 `localhost` 和 `127.0.0.1` 到白名单（开发环境）
- [ ] 配置已保存
- [ ] 浏览器缓存已清除
- [ ] 检查浏览器控制台错误信息
- [ ] 检查Network标签页的地图API请求状态

## 联系支持

如果仍然无法解决：
1. 查看浏览器控制台的完整错误信息
2. 检查高德地图控制台的"配额统计"和"调用日志"
3. 联系高德地图技术支持：https://lbs.amap.com/api/javascript-api/summary

## 当前API Key信息

- **Key**: `703f67ca1815ae0324022fcf7bc2afe9`
- **类型**: Web端(JS API)
- **配置位置**: 高德开放平台 → 应用管理 → 我的应用 → [应用名称] → Web端(JS API) → 设置

